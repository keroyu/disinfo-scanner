# Implementation Plan: YouTube API 官方導入留言

**Branch**: `005-api-import-comments` | **Date**: 2025-11-17 | **Spec**: `/specs/005-api-import-comments/spec.md`
**Input**: Feature specification from `/specs/005-api-import-comments/spec.md`

**Note**: This plan generates the technical design for Phase 0-1 implementation. Phase 2 tasks will be generated by `/speckit.tasks`.

## Summary

Implement a **standalone YouTube API official comment import feature** (independent of urtubeapi) that allows users to import video comments and replies from YouTube's official API into the DISINFO_SCANNER database. Users input a video URL via modal, system checks if video/channel exist in DB, fetches preview data from YouTube API, allows optional channel tag selection, and performs staged import (channels → videos → comments) with reply recursion limited to 3 levels. Success is confirmed via modal message with dynamic AJAX list update (no page refresh).

## Technical Context

**Language/Version**: PHP 8.2+ (Laravel 11.x framework)
**Primary Dependencies**:
- Google API PHP Client (`google/apiclient`)
- Laravel Eloquent ORM
- Tailwind CSS (frontend)
- Alpine.js / Livewire (modal interactions)

**Storage**: MySQL/MariaDB (existing DISINFO_SCANNER schema)
**Testing**: PHPUnit (unit), Feature tests (integration), Contract tests (API boundaries)
**Target Platform**: Web application (server-side PHP + client-side JavaScript)
**Project Type**: Web (backend API + frontend modal)
**Performance Goals**:
- Modal open: <3 seconds
- URL/channel check: <1 second
- API preview fetch: <5 seconds
- Full import (all comments): <30 seconds

**Constraints**:
- YouTube API quota management (1 unit/preview, variable/full import based on comment count)
- No shared pages/code with urtubeapi (complete independence)
- Recursive reply depth limited to 3 layers
- Database consistency: staged import (channels → videos → comments)

**Scale/Scope**:
- Single feature in existing Laravel app
- ~500-800 lines of new backend code (service + controller)
- ~300-400 lines frontend (modal component)
- 1-2 new database migrations (comment_count field, parent_comment_id FK)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Justification |
|-----------|--------|---------------|
| **I. Test-First Development** | ✅ PASS | All new services + controllers + API endpoints will have unit & feature tests written before implementation |
| **II. API-First Design** | ✅ PASS | Backend API contracts defined in `/contracts/` before UI; Laravel REST endpoints will be clearly documented |
| **III. Observable Systems** | ✅ PASS | Structured logging (Laravel Log facade) for API calls, import stages, errors; trace IDs via request context |
| **IV. Contract Testing** | ✅ PASS | YouTube API client boundary tests; Database transaction contract tests; Service layer contract tests required |
| **V. Semantic Versioning** | ✅ PASS | Schema migrations tagged v0.18+ (MINOR: new feature); API changes backward-compatible |

**Gate Result**: ✅ **PASS** – Feature aligns with all 5 constitutional principles. No violations.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
app/
├── Http/Controllers/
│   └── Api/
│       └── ImportCommentsController.php        [NEW: API endpoint for import workflow]
│
├── Services/
│   ├── YoutubeApiClient.php                    [NEW: YouTube API wrapper with error handling]
│   ├── CommentImportService.php                [NEW: Core import logic (stages 1-3)]
│   └── ChannelTagManager.php                   [NEW: Channel-tag pivot management]
│
├── Models/
│   ├── Video.php                               [MODIFY: Add comment_count field accessor]
│   ├── Channel.php                             [MODIFY: Add last_import_at, tag relationship]
│   ├── Comment.php                             [MODIFY: Add parent_comment_id FK]
│   └── Tag.php                                 [EXISTING: No changes]
│
└── Jobs/
    └── ImportCommentsJob.php                   [NEW: Queue job for async import (optional)]

resources/
└── views/
    └── components/
        └── import-comments-modal.blade.php     [NEW: Modal UI component + inline JS]

routes/
└── api.php                                     [MODIFY: Add POST /api/comments/check, POST /api/comments/import]

database/
└── migrations/
    ├── 2025_11_17_add_comment_count_to_videos.php     [NEW: Add comment_count nullable field]
    └── 2025_11_17_add_parent_id_to_comments.php       [NEW: Add parent_comment_id FK]

tests/
├── Feature/
│   └── ImportCommentsTest.php                  [NEW: Feature test (scenarios 1-3)]
│
├── Unit/
│   ├── YoutubeApiClientTest.php               [NEW: API client contract tests]
│   ├── CommentImportServiceTest.php           [NEW: Service layer contract tests]
│   └── ChannelTagManagerTest.php              [NEW: Tag pivot logic tests]
│
└── Contract/
    └── ImportCommentsApiContract.php           [NEW: API boundary contract tests]
```

**Structure Decision**:
- **Backend (Laravel)**: New service classes for YouTube API interaction and import orchestration, isolated from urtubeapi code
- **Frontend**: Reusable Blade modal component with Alpine.js for interactive state management
- **Migrations**: Two schema additions (comment_count, parent_comment_id) to existing tables
- **Tests**: Full coverage per constitutional principle I (Test-First); contract tests for API boundaries per principle IV

## Complexity Tracking

**No constitutional violations** – no complexity tracking needed.

---

## Phase 0: Research (Not Yet Executed)

Research agenda will address:
1. YouTube API Client Library (google/apiclient) best practices for rate limiting and error recovery
2. Recursive data structure patterns for multi-level comment replies
3. Transaction management for staged imports (Laravel's database transactions)
4. AJAX polling vs. WebSocket for dynamic list updates post-import
5. Timestamp format standardization (2025-06-13 21:00:03 format across all tables)

**Output**: `/specs/005-api-import-comments/research.md` (to be generated by research agents)

---

## Phase 1: Design & Contracts (Outlined Below)

### 1a. Data Model Design (`data-model.md`)

**Current Database Schema**:

- **channels**:
  ```sql
  channel_id VARCHAR PRIMARY KEY
  channel_name VARCHAR NULLABLE
  tag_ids VARCHAR NULLABLE              -- Comma-separated tag IDs (e.g., "6,9")
  first_import_at DATETIME NULLABLE
  last_import_at DATETIME NULLABLE
  created_at DATETIME
  updated_at DATETIME
  ```
  - **Relationship**: `hasMany(Video, 'channel_id')`
  - **Tag Storage**: `tag_ids` stores comma-separated tag IDs instead of pivot table
  - **Deleted Fields**: `video_count`, `comment_count` (removed; use aggregation instead)

- **videos**:
  ```sql
  video_id VARCHAR PRIMARY KEY
  channel_id VARCHAR NOT NULL         -- FK to channels.channel_id
  title VARCHAR NULLABLE
  published_at DATETIME NULLABLE
  comment_count INTEGER NULLABLE      -- Calculated after comment import
  created_at DATETIME
  updated_at DATETIME
  ```
  - **Relationship**: `belongsTo(Channel, 'channel_id')`, `hasMany(Comment, 'video_id')`
  - **Index**: `channel_id`

- **comments**:
  ```sql
  comment_id VARCHAR PRIMARY KEY
  video_id VARCHAR NOT NULL           -- FK to videos.video_id
  author_channel_id VARCHAR NOT NULL  -- FK to authors.author_channel_id
  text TEXT NOT NULL
  like_count INTEGER DEFAULT 0
  published_at DATETIME NULLABLE
  parent_comment_id VARCHAR NULLABLE  -- FK to comments.comment_id (reply hierarchy)
  imported_at DATETIME NULLABLE
  created_at DATETIME
  updated_at DATETIME
  ```
  - **Relationship**: `belongsTo(Video, 'video_id')`, `belongsTo(Author, 'author_channel_id')`
  - **Self-referencing**: `belongsTo(Comment, 'parent_comment_id')` for replies
  - **Indexes**: `video_id`, `author_channel_id`, `parent_comment_id`, `like_count`, `published_at`

- **tags**:
  ```sql
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT
  code VARCHAR UNIQUE NOT NULL
  name VARCHAR NOT NULL
  description TEXT NULLABLE
  color VARCHAR NOT NULL
  created_at DATETIME
  updated_at DATETIME
  ```
  - **No direct relationship to Channel** (tags stored as comma-separated IDs in channels.tag_ids)

- **authors**:
  ```sql
  author_channel_id VARCHAR PRIMARY KEY
  name VARCHAR NULLABLE
  profile_url VARCHAR NULLABLE
  created_at DATETIME
  updated_at DATETIME
  ```
  - **Relationship**: `hasMany(Comment, 'author_channel_id')`

**Data Model Notes**:
- **Tag Storage**: `channels.tag_ids` uses comma-separated format (e.g., "6,9" for multiple tags)
  - Helper methods: `getTagIdsArray()` converts to `[6, 9]`, `setTagIdsFromArray()` converts back
  - No `channel_tags` pivot table (removed for simplicity)
- **Comment Count**: Stored in `videos.comment_count`, updated after each import
  - Channel total = SUM of all videos' comment_count (calculated via aggregation)
- **Reply Hierarchy**: `comments.parent_comment_id` creates self-referencing tree (max 3 levels)
- **Timestamps**: All datetime fields in format `2025-06-13 21:00:03` (UTC)

**Validation Rules**:
- Video URL: Must be valid YouTube URL (youtu.be or youtube.com/watch?v=)
- Video published_at: Valid ISO 8601 or datetime, converted to `2025-06-13 21:00:03` format
- Comment text: Non-null, max 5000 chars (YouTube limit)
- Channel name: Non-null, max 255 chars
- Tag IDs: Must exist in `tags` table before assignment

---

### 1b. API Contracts (`/contracts/`)

**Endpoint 1: Check Video & Channel Existence**

```
POST /api/comments/check
Request:
{
  "video_url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
}

Response (Video Exists):
{
  "status": "video_exists",
  "message": "影片已建檔，請利用更新功能導入留言"
}

Response (Video Missing, Channel Exists):
{
  "status": "new_video_existing_channel",
  "channel_id": "UCxxxxx",
  "channel_title": "Channel Name",
  "video_title": "Video Title",
  "comment_count_total": 1250,
  "preview_comments": [
    {
      "comment_id": "Ugx...",
      "author_channel_id": "UCyyyyy",
      "content": "Great video!",
      "like_count": 42,
      "published_at": "2025-11-15 10:30:45"
    },
    ...max 5
  ]
}

Response (Video & Channel Both Missing):
{
  "status": "new_video_new_channel",
  "channel_id": "UCxxxxx",
  "channel_title": "Channel Name",
  "video_title": "Video Title",
  "comment_count_total": 1250,
  "preview_comments": [... max 5 ...],
  "available_tags": [
    {"id": 1, "name": "政治", "color": "#FF5733"},
    {"id": 2, "name": "社會", "color": "#33FF57"},
    ...
  ]
}

Response (Invalid URL):
{
  "status": "error",
  "code": "INVALID_URL",
  "message": "無法解析的 YouTube URL"
}

Response (API Failure):
{
  "status": "error",
  "code": "API_ERROR",
  "message": "YouTube API 請求失敗",
  "can_retry": true
}
```

**Endpoint 2: Import Comments**

```
POST /api/comments/import
Request:
{
  "video_url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
  "scenario": "new_video_existing_channel" | "new_video_new_channel",
  "channel_tags": [1, 3, 5],  // Tag IDs (required for new channel, optional for existing)
  "import_replies": true
}

Response (Success):
{
  "status": "success",
  "message": "成功導入 1247 則留言",
  "imported_comment_count": 1247,
  "imported_reply_count": 523,
  "channel_id": "UCxxxxx",
  "video_id": "dQw4w9WgXcQ"
}

Response (Failure):
{
  "status": "error",
  "code": "IMPORT_FAILED",
  "message": "導入過程中發生錯誤，已導入 450 則留言",
  "partial_count": 450,
  "can_retry": true
}
```

---

### 1c. Quickstart (`quickstart.md`)

**For Backend Developers:**

```bash
# 1. Run migrations
php artisan migrate

# 2. Test API endpoint (check existing video)
curl -X POST http://localhost:8000/api/comments/check \
  -H "Content-Type: application/json" \
  -d '{"video_url": "https://youtu.be/dQw4w9WgXcQ"}'

# 3. Import new video with tags
curl -X POST http://localhost:8000/api/comments/import \
  -H "Content-Type: application/json" \
  -d '{
    "video_url": "https://youtu.be/dQw4w9WgXcQ",
    "scenario": "new_video_new_channel",
    "channel_tags": [1, 3],
    "import_replies": true
  }'

# 4. Run feature tests
php artisan test --filter=ImportCommentsTest
```

**For Frontend Developers:**

```html
<!-- In /comments page -->
<x-import-comments-modal />

<!-- Alpine.js interaction: Click "官方API導入" button -->
<!-- Modal opens → User inputs URL → AJAX POST /api/comments/check -->
<!-- Show preview or error → AJAX POST /api/comments/import (on confirmation) -->
<!-- Success: Show "成功導入 X 則留言" message → Auto-refresh list via AJAX GET /api/comments -->
```

---

## Phase 2: Task Generation (Next Step)

Run `/speckit.tasks` to generate actionable, dependency-ordered `tasks.md` with:
- Individual story point estimates
- Dependency chains (migrations → services → controller → tests)
- Acceptance test mappings
- Risk mitigations
